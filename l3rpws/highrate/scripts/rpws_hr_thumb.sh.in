#!/usr/bin/env bash
#
# Rename the giferator output and make a thumbnail in the HTML sub directory

# There are 5 types of images generated by the HRS PDS Browse processing
# scripts:
#
# Type               Name Pattern            Generator Script          Size
# ------------------ ----------------------- ------------------------- --------
# WFR 5panel 25Hz   Tyyyyddd_25HZ_WFB        rpws_hr_browse_wfr_25Hz   1024x768
#
# WFR 5panel 2.5kHz Tyyyyddd_2_5KHZ_WFB      rpws_hr_browes_wfr_2_5kHz 1024x768
#
# WBR 2panel 10kHz  Tyyyyddd_hh_10KHZ_WBB    rpws_hr_browse_wbr_10Khz   800x600
#
# WBR 2panel 80kHz  Tyyyyddd_hh_75KHZ_WBB    rpws_hr_browse_wbr_75Khz   800x600
#
# WBR 2panel HFR    Tyyyyddd_hh_10025KHZ_WBB rpws_hr_browse_wbr_HFR     800x600
#                   Tyyyyddd_hh_325KHZ_WBB   
#                   Tyyyyddd_hh_2025KHZ_WBB
#                   (possibly more frequencies)

SIZE_WFR=1024x768
FRACTION_WFR="15.625%%"  # Used to get 160 px wide plots from 1024x768 plots

SIZE_WBR=800x600   
FRACTION_WBR="16%%"    # Used to get 128 px wide plots from 800x600 plots

RASTER_RES=150     # Rasterized the vector data at 150 px/inch


if [ "$1" = "" ] ; then
	echo "Missing input filename argument" 1>&2
	exit 7
fi

sFile=$1
if [ "${sFile: -3}" = "WFB" ] ; then
	sSize=$SIZE_WFR
	sFraction=$FRACTION_WFR
elif [ "${sFile: -3}" = "WBB" ]; then
   sSize=$SIZE_WBR
	sFraction=$FRACTION_WBR
else
	echo "ERROR: Don't know to resize files that end in ${sFile: -3}.PNG" 1>&2
	exit 8
fi


cp %(INST_ETC)s/nodata.png $1.PNG
cp %(INST_ETC)s/nodata.png HTML/$1_TN.PNG


if [ -f batch.eps ] ; then
	echo "INFO: convert -density $RASTER_RES batch.eps -resize $sSize $1.PNG"
	if ! convert  -density $RASTER_RES batch.eps -resize $sSize $1.PNG ; then
		echo "Error converting batch.eps to $1.PNG" 1>&2
		exit 3
	fi
	
	if [ ! -d HTML ] ; then
		if ! mkdir HTML ; then
			echo "Error making directory $(PWD)/HTML" 1>&2 
			exit 3
		fi
	fi
	
	echo "INFO: convert $1.PNG  -resize $sFraction HTML/$1_TN.PNG"
	if ! convert $1.PNG  -resize $sFraction HTML/$1_TN.PNG ; then
		echo "Error resizing $1.PNG to HTML/$1_TN.PNG" 1>&2
		exit 3
	fi
fi

rm batch.eps
exit $?
